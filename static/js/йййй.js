document.addEventListener("DOMContentLoaded",async function(){let e={RATES:"/bookings/api/rates/",TABLES:"/bookings/api/tables/",CALENDAR:"/bookings/api/calendar/",BOOKINGS:"/bookings/api/create/",CALCULATE:"/bookings/api/calculate/",USER_BOOKINGS:"/bookings/api/user-bookings/",SITE_SETTINGS:"/bookings/api/site-settings/"},t="True"===document.getElementById("user_role").innerText,n={currentDate:new Date,currentView:"day",rates:{},tables:[],bookings:[],pricingPlan:null,equipment:[],isAdmin:t,isAuthenticated:!!document.getElementById("user_role").innerText},a={prevBtn:document.getElementById("prev-btn"),nextBtn:document.getElementById("next-btn"),todayBtn:document.getElementById("today-btn"),calendarTitle:document.getElementById("calendar-title"),dayView:document.getElementById("day-view"),weekView:document.getElementById("week-view"),monthView:document.getElementById("month-view"),dayContainer:document.getElementById("day-view-container"),weekContainer:document.getElementById("week-view-container"),monthContainer:document.getElementById("month-view-container"),userBookingsContainer:document.getElementById("user-bookings-container"),tableFilter:document.getElementById("table-filter"),statusFilter:document.getElementById("status-filter"),modal:document.getElementById("booking-modal"),closeModalBtn:document.getElementById("close-modal"),cancelBookingBtn:document.getElementById("cancel-booking"),bookingForm:document.getElementById("booking-form"),bookingDate:document.getElementById("booking-date"),startTime:document.getElementById("booking-start-time"),duration:document.getElementById("booking-duration"),tableSelect:document.getElementById("booking-table"),equipmentCheckboxes:document.querySelectorAll(".equipment-checkbox"),participants:document.getElementById("participants"),notes:document.getElementById("booking-notes"),costDisplay:{table:document.getElementById("tariff-table-cost"),equipment:document.getElementById("tariff-equipment-cost"),total:document.getElementById("tariff-total-cost")}};async function i(){try{await r(),await s(n.currentDate),a.prevBtn?.addEventListener("click",async()=>{await w(-1)}),a.nextBtn?.addEventListener("click",async()=>{await w(1)}),a.todayBtn?.addEventListener("click",async()=>{n.currentDate=new Date,D(),k(),await s(n.currentDate),D()}),a.dayView?.addEventListener("click",()=>x("day")),a.weekView?.addEventListener("click",()=>x("week")),a.monthView?.addEventListener("click",()=>x("month")),a.tableFilter?.addEventListener("change",D),a.statusFilter?.addEventListener("change",D),a.closeModalBtn?.addEventListener("click",y),a.cancelBookingBtn?.addEventListener("click",y),a.bookingForm?.addEventListener("submit",f),a.duration?.addEventListener("change",p),a.tableSelect?.addEventListener("change",p),a.participants?.addEventListener("change",p),a.equipmentCheckboxes?.forEach(e=>{e.addEventListener("change",p)}),a.monthContainer?.addEventListener("click",async function(e){let t=e.target.closest("[data-date]");if(t&&t.dataset.date){let a=new Date(t.dataset.date);n.currentDate=a,n.currentView="day",k(),await s(a),D()}}),a.weekContainer?.addEventListener("click",async function(e){let t=e.target.closest("[data-date][data-table]");if(t){let a=new Date(t.dataset.date),i=new Date,r=a<new Date(i.getFullYear(),i.getMonth(),i.getDate());if(r&&!n.IsAdmin)return;n.currentDate=a,n.currentView="day",k(),await s(a),D()}}),a.dayContainer&&a.dayContainer.addEventListener("click",function(e){let t=e.target.closest(".booking-slot-available");t&&function e(t,n){if(t.preventDefault(),!(null!==document.getElementById("user_role"))){showNotification("Для бронирования стола необходимо войти в систему","warning");return}let a=n.dataset.date,i=n.dataset.time,r=n.dataset.table,o=n.dataset.slotId||"",s=new Date,l=new Date(`${a}T${i}`);if(l<s){showNotification("Это время уже прошло, выберите другое","error");return}m(a,i,r,o)}(e,t)}),document.querySelectorAll(".equipment-checkbox").forEach(e=>{e.addEventListener("change",function(){let e=document.querySelector(`select[name="equipment_quantity_${this.value}"]`);e&&e.classList.toggle("hidden",!this.checked),p()})}),document.querySelectorAll(".equipment-quantity").forEach(e=>{e.addEventListener("change",p)}),n.siteSettings.close_time&&n.siteSettings.close_time.match(/^\d{1,2}:\d{2}$/)||(n.siteSettings.close_time="22:00"),await D(),k()}catch(e){console.error("Ошибка инициализации:",e),H("Не удалось загрузить данные приложения")}}async function r(){try{showLoader();let[t,i,r]=await Promise.all([fetch(e.RATES),fetch(e.TABLES),fetch(e.USER_BOOKINGS)]);if(!t.ok)throw Error("Ошибка загрузки тарифов");if(!i.ok)throw Error("Ошибка загрузки столов");if(!t.ok||!t.headers.get("content-type")?.includes("application/json"))throw Error("Ошибка загрузки тарифов");if(!i.ok||!i.headers.get("content-type")?.includes("application/json"))throw Error("Ошибка загрузки столов");if(n.rates=await t.json(),n.tables=await i.json(),n.pricingPlan=n.rates.pricing_plan,await s(n.currentDate),r.ok&&r.headers.get("content-type")?.includes("application/json")){let o=await r.json();n.bookings=o.bookings||[]}}catch(d){console.error("Ошибка загрузки данных:",d),H("Не удалось загрузить данные приложения")}finally{hideLoader(),a.tableSelect&&n.tables.length&&(a.tableSelect.innerHTML=n.tables.map(e=>`<option value="${e.id}" 
                    data-type="${e.table_type}" 
                    data-capacity="${e.max_capacity}">
                    Стол #${e.number} (${e.table_type})
                </option>`).join("")),a.bookingDate&&(a.bookingDate.valueAsDate=new Date),l(),p()}}async function o(e,t={}){let n=await fetch(e,t);if(401===n.status||403===n.status)throw window.location.href="/login/?next="+encodeURIComponent(window.location.pathname),setTimeout(()=>{},3e3),Error("Требуется авторизация");if(!n.ok)throw Error(`HTTP error! status: ${n.status}`);return n}async function s(t){try{let a=t.toISOString().split("T")[0];showLoader();let i=await fetch(`${e.SITE_SETTINGS}?date=${a}`);if(!i.ok||!i.headers.get("content-type")?.includes("application/json"))throw Error("Ошибка получения настроек");let r=await i.json();if(!r.current_day)throw Error("Неверный формат настроек");return n.siteSettings={open_time:r.current_day.open_time||"09:00",close_time:r.current_day.close_time||"22:00",is_open:!1!==r.current_day.is_open},l(),!0}catch(o){return console.error("Ошибка загрузки настроек дня:",o),n.siteSettings={open_time:"09:00",close_time:"22:00",is_open:!0},l(),!1}finally{hideLoader()}}function l(){if(!a.startTime)return;a.startTime.innerHTML="";let[e,t]=n.siteSettings.open_time.split(":").map(Number),[i,r]=n.siteSettings.close_time.split(":").map(Number),o=new Date;o.setHours(e,t,0,0);let s=new Date;s.setHours(i,r,0,0);let l=new Date(o),d=new Date(s);d.setHours(s.getHours()-1);let c=new Date;for(;l<=d;){if(l>c){let u=l.getHours().toString().padStart(2,"0"),g=l.getMinutes().toString().padStart(2,"0"),m=`${u}:${g}`,p=document.createElement("option");p.value=m,p.textContent=m,a.startTime.appendChild(p)}l.setHours(l.getHours()+1)}}function d(e,t,n,a){let i=document.getElementById("tariff-summary"),r=document.getElementById("tariff-name"),o=document.getElementById("tariff-table-cost"),s=document.getElementById("tariff-equipment-cost"),l=document.getElementById("tariff-total-cost");r.textContent=e||"—",o.textContent=`${t} ₽`,s.textContent=`${n} ₽`,l.textContent=`${a} ₽`,i.classList.remove("hidden")}a.bookingDate?.addEventListener("change",async()=>{let e=a.bookingDate.valueAsDate;e&&(n.currentDate=e,k(),await s(e),await D())});let c=a.bookingForm;async function u(){let e=a.bookingDate.value,t=a.startTime.value,n=document.getElementById("booking-table")?.value,i=parseInt(a.duration?.value)||60;e&&t&&n&&i&&await g({date:e,time:t,tableId:n,duration:i})}async function g({date:e,time:t,tableId:n,duration:i}){try{let r=await fetch(`/bookings/api/get-booking-info/?date=${e}&time=${t}&table_id=${n}&duration=${i}`,{redirect:"manual"});if("opaqueredirect"===r.type||r.redirected){window.location.href="/accounts/signin/?next="+encodeURIComponent(window.location.pathname+window.location.search),setTimeout(()=>{},3e3);return}let o=r.headers.get("content-type");if(!o||!o.includes("application/json"))throw Error("Сервер вернул неожиданный ответ");let s=await r.json();if(!r.ok||s.error){alert(s.error||"Ошибка при получении тарифа.");return}let l=s.price_per_hour,d=s.price_per_half_hour,c=s.tariff_description||"Стандартный тариф";a.bookingForm.dataset.pricePerHour=l,a.bookingForm.dataset.pricePerHalfHour=d,p({tablePriceHour:l,tablePriceHalfHour:d,equipment:s.equipment||[],tariffName:c})}catch(u){console.error("Ошибка при получении тарифа:",u),u.message.includes("authorization")||u.message.includes("auth")||u.message.includes("неожиданный")?(window.location.href="/accounts/signin/?next="+encodeURIComponent(window.location.pathname+window.location.search),setTimeout(()=>{},3e3)):showNotification("Ошибка при получении тарифа: "+u.message,"error")}}async function m(e,t,i,r){let o=t.includes(":")?t:`${t}:00`;try{let s=await fetch(`/bookings/api/get-booking-info/?date=${e}&time=${o}&table_id=${i}`,{redirect:"manual"}),l=s.headers.get("content-type");if(!l||!l.includes("application/json"))throw Error("Сервер вернул неожиданный ответ");let c=await s.json();if(!s.ok||c.error){alert(c.error||"Ошибка при получении тарифной информации.");return}a.bookingForm.dataset.discount=c.discount||0;let{open_time:u,close_time:g}=n.siteSettings,m=new Date(`${e}T${u}:00`),$=new Date(`${e}T${g}:00`),y=new Date(`${e}T${o}:00`),f=Math.min(c.max_duration,Math.floor(($-y)/6e4));d(c.tariff_description||"Стандартный тариф",Math.round(c.price_per_half_hour),0,Math.round(c.final_price)),a.bookingForm.dataset.pricePerHour=c.price_per_hour,a.bookingForm.dataset.pricePerHalfHour=c.price_per_half_hour,a.bookingDate.value=e,a.startTime.value=o,function e(t,n,a){let i=document.getElementById("booking-start-time");i.innerHTML="";let r=new Date,o=new Date(t);if(r.getMinutes()>=30?(o.setHours(r.getHours()+1),o.setMinutes(0,0,0)):(o=new Date(r)).setMinutes(30,0,0),!(o>n)){for(;o<=n;){let s=o.toTimeString().slice(0,5),l=new Option(s,s);i.add(l),o.setMinutes(o.getMinutes()+30)}i.options.length>0&&(i.selectedIndex=0),a&&[...i.options].some(e=>e.value===a)&&(i.value=a)}}(m,$,o),function e(t,n){let a=document.getElementById("booking-table");if(!a)return;a.innerHTML="",t.forEach(e=>{let t=new Option(`Стол #${e.number} (${e.table_type})`,e.id);t.dataset.maxPlayers=e.max_capacity||2,a.add(t)}),a.value=n;let i=t.find(e=>e.id===parseInt(n)),r=document.getElementById("table-type-name");r&&(r.textContent=i?.table_type||"")}(c.tables,i),function e(t,n){let a=document.getElementById("participants");if(!a)return;let i=t.find(e=>e.id===parseInt(n)),r=i?.max_capacity||2;a.innerHTML="";for(let o=2;o<=r;o++){let s=new Option(`${o} игрок${o>1?"а":""}`,o);a.add(s)}}(c.tables,i),function e(t,n,i){let r=document.getElementById("booking-duration");r.innerHTML="";for(let o=t;o<=n;o+=30){let s=Math.floor(o/60),l=o%60,d=s>0?`${s} час${s>=5?"ов":s>1?"а":""}`:"";l>0&&(d+=` ${l} мин`);let c=new Option(d.trim()+(o===n&&n<i?" (до закрытия)":""),o);r.add(c)}r.value=60,a.duration.addEventListener("change",()=>{p()})}(c.min_duration,f,c.max_duration),function e(t){let n=document.getElementById("equipment-container");n&&t&&(n.innerHTML="",t.forEach(e=>{let t=document.createElement("div");t.className="equipment-item mb-2 p-1 border rounded",t.innerHTML=`
            <label class="flex items-center">
                <input type="checkbox" name="equipment" value="${e.id}"
                    class="equipment-checkbox mr-2 border rounded"
                    data-price-hour="${e.price_per_hour}"
                    data-price-half-hour="${e.price_per_half_hour}">
                <span class="font-medium">${e.name}</span>
            </label>
            ${e.description?`<p class="text-sm text-gray-500 mt-1">${e.description}</p>`:""}
        `,n.appendChild(t)}),document.querySelectorAll(".equipment-checkbox").forEach(e=>{e.addEventListener("change",()=>p())}))}(c.equipment),a.participants.value="2",a.notes.value="",document.getElementById("is-group").checked=!1,a.bookingForm&&(a.bookingForm.dataset.slotId=r||""),b({table_cost:c.base_price,equipment_cost:0,total_cost:c.final_price}),a.modal.classList.remove("hidden")}catch(h){if(console.error("Ошибка при открытии модалки бронирования:",h),h.message.includes("authorization")||h.message.includes("auth")||h.message.includes("неожиданный")){if(n.isAuthenticated){showNotification("Чтобы забронировать, войдите в личный кабинет или зарегистрируйтесь","warning"),window.location.href="/accounts/signin/?next="+encodeURIComponent(window.location.pathname+window.location.search),setTimeout(()=>{},3e3);return}}else alert("Не удалось получить информацию о бронировании. Повторите попытку позже.")}}async function p({tablePriceHour:e=parseFloat(a.bookingForm.dataset.pricePerHour),tablePriceHalfHour:t=parseFloat(a.bookingForm.dataset.pricePerHalfHour),tariffName:n="Стандартный тариф"}={}){try{let i=parseInt(a.duration?.value)||60,r=0,o=r=i<=30?t:60===i?e:Math.floor(i/60)*e+Math.ceil(i%60/30)*t,s=parseFloat(a.bookingForm.dataset.discount)||0;s>0&&(o=r*(1-s/100));let l=[...document.querySelectorAll(".equipment-checkbox:checked")].reduce((e,t)=>{let n=parseFloat(t.dataset.priceHalfHour)||0,a=parseFloat(t.dataset.priceHour)||2*n,r=0;return r=i<=30?n:60===i?a:Math.floor(i/60)*a+Math.ceil(i%60/30)*n,e+r},0),c=Math.round(o+l);d(n,Math.round(o),Math.round(l),c),b({table_cost:Math.round(o),equipment_cost:Math.round(l),total_cost:c})}catch(u){console.error("Ошибка расчета стоимости:",u),showNotification(`Ошибка расчета стоимости: ${u.message}`,"error")}}function $(e,t){let n=document.getElementById("duration-select");if(n){n.innerHTML="";for(let a=e;a<=t;a+=30){let i=document.createElement("option");i.value=a,i.textContent=`${a} мин`,n.appendChild(i)}n.value=e}}function y(){a.modal.classList.add("hidden")}function b(e){a.costDisplay.table&&(a.costDisplay.table.textContent=`${e.table_cost} ₽`),a.costDisplay.equipment&&(a.costDisplay.equipment.textContent=`${e.equipment_cost} ₽`),a.costDisplay.total&&(a.costDisplay.total.textContent=`${e.total_cost} ₽`)}async function f(t){t.preventDefault();try{parseFloat(a.duration.value);let n=parseInt(a.duration.value)||60,i=Array.from(document.querySelectorAll(".equipment-checkbox:checked")).map(e=>{let t=e.closest(".equipment-item").querySelector("select"),n=t?parseInt(t.value):1;return{id:parseInt(e.value),quantity:n}}),r={date:a.bookingDate.value,start_time:a.startTime.value,duration:n,table_id:parseInt(a.tableSelect.value),equipment:i,participants:parseInt(a.participants.value),is_group:document.getElementById("is-group").checked,notes:a.notes.value,slot_id:a.bookingForm.dataset.slotId||null},o=await fetch(e.BOOKINGS,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":T()},body:JSON.stringify(r)});if(!o.ok){let s=await o.json().catch(()=>({}));throw Error(s.message||"Ошибка сервера")}let l=await o.json();if(l.success)showNotification("Бронирование успешно создано!","success"),y(),await D(),await h();else throw Error(l.error||"Неизвестная ошибка")}catch(d){console.error("Ошибка бронирования:",d),showNotification("Ошибка: "+d.message,"error")}}async function h(){try{let t=await fetch(e.USER_BOOKINGS);if(!t.ok)throw Error("Ошибка загрузки бронирований");let a=await t.json();n.bookings=a.bookings||[],I()}catch(i){console.error("Ошибка загрузки бронирований:",i)}}async function w(e){let t=new Date(n.currentDate);switch(n.currentView){case"day":t.setDate(t.getDate()+e);break;case"week":t.setDate(t.getDate()+7*e);break;case"month":let i=t.getDate();t.setDate(1),t.setMonth(t.getMonth()+e);let r=new Date(t.getFullYear(),t.getMonth()+1,0).getDate();t.setDate(Math.min(i,r))}n.currentDate=t,a.bookingDate&&(a.bookingDate.valueAsDate=n.currentDate),k(),await s(t),D()}function v(){a.costDisplay.table&&(a.costDisplay.table.textContent="—"),a.costDisplay.equipment&&(a.costDisplay.equipment.textContent="—"),a.costDisplay.total&&(a.costDisplay.total.textContent="—")}function x(e){["day","week","month"].includes(e)&&(n.currentView=e,D(),k())}function k(){(function e(){let t=["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],i=n.currentDate,r="";switch(n.currentView){case"day":{let o=["Вс","Пн","Вт","Ср","Чт","Пт","Сб"][i.getDay()];r=`${i.getDate()} ${t[i.getMonth()]} ${i.getFullYear()} ${o}`;break}case"week":{let s=new Date(i),l=s.getDay();0===l&&(l=7),s.setDate(s.getDate()-(l-1));let d=new Date(s);d.setDate(s.getDate()+6),r=`${s.getDate()}–${d.getDate()} ${t[d.getMonth()]} ${d.getFullYear()}`;break}case"month":r=`${t[i.getMonth()]} ${i.getFullYear()}`}a.calendarTitle&&(a.calendarTitle.textContent=r)})(),a.dayView&&(a.dayView.classList.toggle("bg-green-600","day"===n.currentView),a.dayView.classList.toggle("text-white","day"===n.currentView)),a.weekView&&(a.weekView.classList.toggle("bg-green-600","week"===n.currentView),a.weekView.classList.toggle("text-white","week"===n.currentView)),a.monthView&&(a.monthView.classList.toggle("bg-green-600","month"===n.currentView),a.monthView.classList.toggle("text-white","month"===n.currentView)),a.dayContainer&&a.dayContainer.classList.toggle("hidden","day"!==n.currentView),a.weekContainer&&a.weekContainer.classList.toggle("hidden","week"!==n.currentView),a.monthContainer&&a.monthContainer.classList.toggle("hidden","month"!==n.currentView),function e(){if(a.prevBtn&&a.nextBtn){let t=E(n.currentDate);a.prevBtn.dataset.date=t,a.nextBtn.dataset.date=t}}()}function E(e){return e.toISOString().split("T")[0]}async function D(){try{let t=a[`${n.currentView}Container`];if(t.innerHTML='<div class="text-center py-4">Загрузка...</div>',!n.siteSettings.is_open&&"day"===n.currentView){t.innerHTML=`
                <div class="p-8 text-center">
                    <div class="inline-block p-6 bg-gray-100 rounded-lg">
                        <i class="fas fa-calendar-times text-4xl text-gray-400 mb-4"></i>
                        <h3 class="text-xl font-medium text-gray-700">Клуб закрыт</h3>
                        <p class="text-gray-500 mt-2">${_(n.currentDate)}</p>
                    </div>
                </div>
            `;return}let i=n.currentDate;"week"===n.currentView&&(i=function e(t){let n=new Date(t),a=n.getDay();return n.setDate(n.getDate()+((0===a?-6:1)-a)),n}(n.currentDate));let r=new URLSearchParams({date:E(i),view:n.currentView,table:a.tableFilter?.value||"all",status:a.statusFilter?.value||"all"}),o=await fetch(`${e.CALENDAR}?${r}`);if(!o.ok)throw Error("Ошибка загрузки календаря");let s=await o.json();!function e(t){let i=a[`${n.currentView}Container`];if(i)switch(n.currentView){case"day":i.innerHTML=function e(t){var a;if(!t.is_working_day)return`
            <div class="p-8 text-center">
                <div class="inline-block p-6 bg-gray-100 rounded-lg">
                    <i class="fas fa-calendar-times text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-xl font-medium text-gray-700">Выходной день</h3>
                    <p class="text-gray-500 mt-2">${_(t.date)}</p>
                </div>
            </div>
        `;let i=t.time_slots.map(e=>(function e(t,a){let[i,r]=t.split(":").map(Number),o=new Date(a.date);o.setHours(i,r,0,0);let[s,l]=n.siteSettings.close_time.split(":").map(Number),d=new Date(a.date);d.setHours(s,l,0,0);let c=a.slot_duration||60,u=new Date(o);u.setMinutes(u.getMinutes()+c);let g=function e(t,a){if(n.isAdmin)return!1;let i=new Date,[r,o]=a.split(":").map(Number),s=new Date(t);return s.setHours(r,o,0,0),s<i}(a.date,t);return u>d||g?"":`
<div class="flex border-b border-gray-200 hover:bg-gray-50 booking-slot-row">
    <div class="w-24 md:w-32 p-3 text-right text-sm font-semibold text-gray-700">${t}</div>
    <div class="flex-1 grid grid-cols-${a.tables.length} divide-x divide-gray-200">
        ${a.tables.map(e=>{let i=function e(t,a,i){let r=t.day_schedule[a]?.[i]||null,o=new Date,s=new Date(t.date),[l,d]=i.split(":").map(Number),c=new Date(s);c.setHours(l,d,0,0);let u=n.siteSettings.close_time||"22:00",[g,m]=u.split(":").map(Number),p=new Date(s);p.setHours(g,m,0,0);let $,y,b,f,h;if(c<o){if(!n.isAdmin)return"";$="-",y=!1,b="bg-gray-200",f="text-gray-500 italic",h="cursor-default pointer-events-none"}else r&&"available"!==r.status?($=r.status||"Занято",y=!1,b="bg-red-100",f="text-red-800",h="cursor-default pointer-events-none"):c>=p?($="закрыто",y=!1,b="bg-gray-100",f="text-gray-500",h="cursor-default pointer-events-none"):($="Свободно",y=!0,b="bg-green-100 hover:bg-green-200",f="text-green-800",h="cursor-pointer");return`
<div class="flex items-center justify-center border-b mt-1 ml-1 rounded-xl p-2 min-h-12 ${b} ${h} ${y?"booking-slot-available":""}"
     data-date="${t.date}" 
     data-time="${i}" 
     data-table="${a}" 
     data-slot-id="${r?.slot_id||""}">
    <span class="text-sm ${f}">${$}</span>
</div>
`}(a,e.id,t);return i}).join("")}
    </div>
</div>
`})(e,t)).join("");return`
        <div class="overflow-hidden rounded-lg border border-gray-200 shadow-sm">
            ${a=t.tables,`
        <div class="flex border-b border-gray-200 bg-gray-50">
            <div class="w-24 md:w-32 p-3">Время</div>
            ${a.map(e=>`
                <div class="flex-1 p-3 text-center font-medium">
                    Стол #${e.number}<br>
                    <span class="text-sm text-gray-500">${e.table_type}</span>
                </div>
            `).join("")}
        </div>
    `}
            ${i}
        </div>
    `}(t);break;case"week":i.innerHTML=function e(t){var a;if(!t.days||!t.tables)return'<div class="p-4 text-center text-gray-500">Нет данных для отображения</div>';let i=Object.entries(t.days).map(([e,t])=>({date:e,...t})),r=`
        <div class="grid grid-cols-${i.length+1} gap-2  mb-2 text-sm font-medium">
            <div class="bg-white p-2"></div>
            ${i.map(e=>`
                <div class="bg-white p-2 text-center rounded-xl">
                    <div>${new Date(e.date).toLocaleDateString("ru-RU",{weekday:"short"})}</div>
                    <div>${new Date(e.date).getDate()}</div>
                </div>
            `).join("")}
        </div>
    `,o=`
        <div class="grid grid-cols-${i.length+1} gap-2 bg-gray-200 text-sm">
            ${(a=t.tables,`
        <div class="flex flex-col gap-y-2">
            ${a.map(e=>`
                <div class="bg-white p-2 h-14 mt-1  border-b rounded-xl flex flex-col text-right justify-center shadow-sm">
                    <div class="font-medium">Стол #${e.number}</div>
                    <div class="text-xs text-gray-500">${e.table_type}</div>
                </div>
            `).join("")}
        </div>
    `)}
            ${i.map(e=>(function e(t,a){let i=new Date,r=new Date(a.date),o=r<new Date(i.getFullYear(),i.getMonth(),i.getDate());return`
        <div class="flex flex-col gap-y-2">
            ${t.tables.map(e=>{let t=a.day_schedule?.[e.id]||{},i=Object.entries(t).filter(([e])=>"_meta"!==e);if(!a.is_working_day||!i.length)return`<div class="bg-gray-100 mt-1 text-gray-400 h-14 border-b rounded-xl flex text-right justify-center shadow-sm">–</div>`;let r=i.filter(([e,t])=>"available"!==t.status).length,s=i.length,l=o&&!n.isAdmin;return`<div class="h-14 border-b flex mt-1  items-center justify-center rounded-xl cursor-pointer px-2 py-1 shadow-sm ${l?"bg-gray-200 text-gray-500 cursor-not-allowed":r===s?"bg-red-100 text-red-800":r>0?"bg-yellow-100 text-yellow-800":"bg-green-100 text-green-800"} ${l?"pointer-events-none":""} slot-available"
                             title="Занято ${r} из ${s}"
                             data-date="${a.date}"
                             data-table="${e.id}">
                             ${r}/${s}
                        </div>`}).join("")}
        </div>
    `})(t,e)).join("")}
        </div>
    `;return r+o}(t),a.userBookingsContainer&&(a.userBookingsContainer.innerHTML=I(t.user_bookings)),document.querySelectorAll(".slot-available").forEach(e=>{e.addEventListener("click",()=>{let{date:t,table:n}=e.dataset;m(t,null,n,null)})});break;case"month":i.innerHTML=function e(t){if(!t.weeks||!t.tables)return'<div class="p-4 text-center text-gray-500">Нет данных для отображения</div>';let n=new Date;n.setHours(0,0,0,0);let a=t.month?new Date(t.month+"-01"):new Date,i={};t.user_bookings&&t.user_bookings.forEach(e=>{e.date&&(i[e.date]=i[e.date]||[],i[e.date].push(e))});let r=(e,t)=>{if(!e||!e.date)return"bg-gray-100 text-gray-400 rounded p-2 text-sm";let a=new Date(e.date);if(isNaN(a.getTime()))return"bg-gray-100 text-gray-400 rounded p-2 text-sm";a.setHours(0,0,0,0);let i=a.toDateString()===n.toDateString(),r=a<n,o=e.is_working_day??!0,s=e.shortened??!1,l="rounded p-2 text-sm";return t?(o?s?l+=" bg-yellow-50 border border-yellow-100 text-yellow-800":i?l+=" bg-blue-50 border border-blue-200 text-blue-800":r?l+=" bg-gray-100 text-gray-500":l+=" bg-white border border-gray-200 hover:bg-gray-50":l+=" bg-red-50 border border-red-100 text-red-800",!r&&t&&o&&!s&&(l+=" cursor-pointer"),l):`${l} bg-gray-100 text-gray-400`},o=e=>{if(!e||!e.date)return"";let t=new Date(e.date);if(isNaN(t.getTime()))return"";t.setHours(0,0,0,0);let a=e.is_working_day??!0,r=e.shortened??!1,o=e.working_hours;if(!a)return'<div class="text-xs text-red-600 mt-1">Выходной</div>';if(r)return`<div class="text-xs text-yellow-600 mt-1">Сокращенный день (${o?.open_time??"?"}-${o?.close_time??"?"})</div>`;let s=i[e.date]||[],l=s.length;return 0===l?'<div class="text-xs text-gray-500 mt-1">Нет бронирований</div>':`<div class="text-xs ${t<n?"text-gray-400":"text-green-600"} mt-1">${l} бронирование${l>1?"й":""}</div>`},s=`
        <div class="grid grid-cols-7 gap-2 mb-4">
            <div class="text-center font-medium">Пн</div>
            <div class="text-center font-medium">Вт</div>
            <div class="text-center font-medium">Ср</div>
            <div class="text-center font-medium">Чт</div>
            <div class="text-center font-medium">Пт</div>
            <div class="text-center font-medium">Сб</div>
            <div class="text-center font-medium">Вс</div>
        </div>
    `,l=t.weeks.map(e=>`
            <div class="grid grid-cols-7 gap-2">
                ${e.map(e=>{if(!e||!e.date)return'<div class="p-2"></div>';let t=new Date(e.date);if(isNaN(t.getTime()))return'<div class="p-2"></div>';let n=t.getDate(),i=t.getMonth()===a.getMonth();return`
                        <div class="${r(e,i)}" data-date="${e.date}">
                            <div class="font-medium">${n}</div>
                            ${o(e)}
                        </div>
                    `}).join("")}
            </div>
        `).join("");return`
        <div class="calendar-container">
            ${s}
            ${l}
        </div>
    `}(t)}}(s)}catch(l){console.error("Ошибка рендеринга календаря:",l),H("Не удалось загрузить данные календаря"),a.monthContainer.innerHTML=`
      <div class="p-4 text-center text-red-500">
        Ошибка загрузки: ${l.message}
      </div>
    `}}function B(t){confirm("Вы уверены, что хотите отменить бронирование?")&&fetch(`${e.BOOKINGS}${t}/`,{method:"DELETE",headers:{"X-CSRFToken":T()}}).then(e=>{if(e.ok)alert("Бронирование успешно отменено"),D();else throw Error("Ошибка при отмене бронирования")}).catch(e=>{console.error(e),H(e.message)})}c.addEventListener("input",u),c.addEventListener("change",u);let L=document.querySelectorAll(".bg-green-100.cursor-pointer");function S(e){alert(`Оплата бронирования #${e}`)}function I(e){return e?.length?`
            <table class="min-w-full border text-sm text-left">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="px-3 py-2 border">Дата</th>
                        <th class="px-3 py-2 border">Время</th>
                        <th class="px-3 py-2 border">Стол</th>
                        <th class="px-3 py-2 border">Статус</th>
                    </tr>
                </thead>
                <tbody>
                    ${e.map(e=>`
                        <tr>
                            <td class="px-3 py-2 border">${new Date(e.date).toLocaleDateString("ru-RU")}</td>
                            <td class="px-3 py-2 border">${e.start}-${e.end}</td>
                            <td class="px-3 py-2 border">#${e.table_number}</td>
                            <td class="px-3 py-2 border">${e.status}</td>
                        </tr>
                    `).join("")}
                </tbody>
            </table>
        `:`<div class="text-gray-400">Нет активных бронирований на этой неделе.</div>`}function _(e){let t=new Date(e);return isNaN(t)?e:`${t.getDate().toString().padStart(2,"0")}.${(t.getMonth()+1).toString().padStart(2,"0")}.${t.getFullYear()}`}function T(){let e=document.querySelector("[name=csrfmiddlewaretoken]");return e?e.value:""}function H(e){alert(`Ошибка: ${e}`)}L.forEach(e=>{e.addEventListener("click",function(){let e=this.getAttribute("data-time"),t=this.getAttribute("data-table");if(e&&t){let n=new Date,a=n.toISOString().split("T")[0];document.getElementById("booking-date").value=a,document.getElementById("booking-start-time").value=e,document.getElementById("booking-table").value=t,bookingModal.classList.remove("hidden"),p()}})}),i()});